global
  log /dev/log  local0
  log /dev/log  local1 notice
  chroot /var/lib/haproxy
  user haproxy
  group haproxy
  daemon
defaults
  log global
  mode  http
  option  httplog
  option  dontlognull
  contimeout 5000
  clitimeout 50000
  srvtimeout 50000
  errorfile 400 /etc/haproxy/errors/400.http
  errorfile 403 /etc/haproxy/errors/403.http
  errorfile 408 /etc/haproxy/errors/408.http
  errorfile 500 /etc/haproxy/errors/500.http
  errorfile 502 /etc/haproxy/errors/502.http
  errorfile 503 /etc/haproxy/errors/503.http
  errorfile 504 /etc/haproxy/errors/504.http
# HTTP frontend
frontend http-in
  bind *:80
{{ range . }}
{{ if eq .Settings.Protocol "http" }}
{{ $normalizedId := .Service.NormalizeId }}
# Services generated from Marathon do not have a domain
# In this example, the last part of the ID is used to prefix the actual domain
# /production/myapp becomes myapp.example.com
{{ if eq .Service.Source "Marathon" }}
{{ $idParts := split $normalizedId "_" }}
{{ $last := len $idParts | sub 1 }}
  acl host_{{ $normalizedId }} hdr(host) -i {{ index $idParts $last }}.example.com
{{ else }}
  acl host_{{ $normalizedId }} hdr(host) -i {{ .Service.Domain }}
{{ end }}
{{ range .Settings.Domains }}
  acl host_{{ $normalizedId }} hdr(host) -i {{ . }}
{{ end }}
{{ end }}
{{ end }}

{{ range . }}
{{ if eq .Settings.Protocol "http" }}
{{ $normalizedId := .Service.NormalizeId }}
  use_backend {{ $normalizedId }}_cluster if host_{{ $normalizedId }}
{{ end }}
{{ end }}
# HTTP backend
{{ range . }}
{{ if eq .Settings.Protocol "http" }}
{{ $normalizedId := .Service.NormalizeId }}
backend {{ .Service.NormalizeId }}_cluster
{{ range .Settings.ConfigItems }}
  {{ . }}
{{end}}
{{ range .Service.Hosts }}
  server {{ $normalizedId }}-{{ .Ip }}-{{ .Port }} {{ .Ip }}:{{ .Port }} check
{{ end }}
{{ end }}
{{ end }}
# TCP
{{ range . }}
{{ if ne .Settings.Protocol "http" }}
{{ $normalizedId := .Service.NormalizeId }}
listen {{ $normalizedId }} :{{ .Service.ListenPort }}
  mode tcp
{{ range .Settings.ConfigItems }}
  {{ . }}
{{end}}

{{ range .Service.Hosts }}
  server {{ $normalizedId }}-{{ .Ip }}-{{ .Port }} {{ .Ip }}:{{ .Port }} check
{{ end }}
{{ end }}
{{ end }}
