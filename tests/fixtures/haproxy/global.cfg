###GLOBAL CONFIG###

frontend http-in
  bind *:80
{{ range . }}
{{ if eq .Settings.Protocol "http" }}
{{ $normalizedId := .Service.NormalizeId }}
  acl host_{{ $normalizedId }} hdr(host) -i {{ .Service.Domain }}
{{ range .Settings.Domains }}
  acl host_{{ $normalizedId }} hdr(host) -i {{ . }}
{{ end }}
{{ end }}
{{ end }}

{{ range . }}
{{ if eq .Settings.Protocol "http" }}
{{ $normalizedId := .Service.NormalizeId }}
  use_backend {{ $normalizedId }}_cluster if host_{{ $normalizedId }}
{{ end }}
{{ end }}

{{ range . }}
{{ if eq .Settings.Protocol "http" }}
{{ $normalizedId := .Service.NormalizeId }}
backend {{ .Service.NormalizeId }}_cluster
{{ range .Settings.ConfigItems }}
  {{ . }}
{{end}}
{{ range .Service.Hosts }}
  server {{ $normalizedId }}-{{ .Ip }}-{{ .Port }} {{ .Ip }}:{{ .Port }} check
{{ end }}
{{ end }}
{{ end }}

{{ range . }}
{{ if ne .Settings.Protocol "http" }}
{{ $normalizedId := .Service.NormalizeId }}
listen {{ .Service.NormalizeId }} :{{ .Service.ListenPort }}
  mode tcp
{{ range .Settings.ConfigItems }}
  {{ . }}
{{end}}

{{ range .Service.Hosts }}
  server {{ $normalizedId }}-{{ .Ip }}-{{ .Port }} {{ .Ip }}:{{ .Port }} check
{{ end }}
{{ end }}
{{ end }}
